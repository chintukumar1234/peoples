<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel ‚Äî Drivers with Directions</title>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // üîπ Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyARe_cDs_WHl7CkCJTjCEaTMFAksmi1SXg",
      authDomain: "maps-41eca.firebaseapp.com",
      databaseURL: "https://maps-41eca-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "maps-41eca",
      storageBucket: "maps-41eca.firebasestorage.app",
      messagingSenderId: "850870521671",
      appId: "1:850870521671:web:6a986f4f81a6cb976b8662",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global variable for all drivers
    let allDrivers = {};

    // üî∏ Listen for driver data
    onValue(ref(db, "drivers"), snapshot => {
      allDrivers = snapshot.exists() ? snapshot.val() : {};
      renderTable();
    });

    // üî∏ Render driver table
    window.renderTable = function () {
      const tbody = document.getElementById("driverTableBody");
      tbody.innerHTML = "";
      let count = 0;
      const q = document.getElementById("searchInput").value.trim().toLowerCase();

      for (const id in allDrivers) {
        const d = allDrivers[id];
        if (!d) continue;

        // search filter
        if (q && !((d.name||"").toLowerCase().includes(q) || (d.gmail||"").toLowerCase().includes(q) || (d.mobile||"").includes(q)))
          continue;

        count++;
        const tr = document.createElement("tr");
        tr.className = d.online ? "onlineRow" : "offlineRow";

        const rider1 = d.rider1_id || "-";
        const rider2 = d.rider2_id || "-";
        const code1 = d.booking1_code || "-";
        const code2 = d.booking2_code || "-";

        tr.innerHTML = `
          <td>${d.name || "-"}</td>
          <td>${d.gmail || "-"}</td>
          <td>${d.mobile || "-"}</td>
          <td>${d.online ? "üü¢ Online" : "üî¥ Offline"}</td>
          <td>
            <div>üë§ Rider1: ${rider1}</div>
            <div>Code: ${code1}</div>
            <hr>
            <div>üë§ Rider2: ${rider2}</div>
            <div>Code: ${code2}</div>
          </td>
          <td>
            <button class="viewMapBtn" data-id="${id}">üó∫Ô∏è View Map</button>
            <button class="deleteBtn" data-id="${id}">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById("driverCount").innerText = count;

      // üî∏ Attach Delete Button Functionality
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = async (e) => {
          const id = e.target.dataset.id;

          const code = prompt("üîê Enter admin code to delete this driver:");
          if (code !== "Chintu@Admin2025") {
            alert("‚ùå Invalid code. You are not authorized to delete this driver.");
            return;
          }

          if (!confirm("‚ö†Ô∏è Are you sure you want to delete this driver?")) return;

          try {
            await remove(ref(db, "drivers/" + id));
            alert("‚úÖ Driver deleted successfully!");
          } catch (error) {
            console.error(error);
            alert("‚ö†Ô∏è Failed to delete driver. Check console for details.");
          }
        };
      });

      // üî∏ Attach View Map Button Functionality
      document.querySelectorAll(".viewMapBtn").forEach(btn => {
        btn.onclick = async (e) => {
          const id = btn.dataset.id;
          await openDriverMap(id);
        };
      });
    };

    // üî∏ Open map popup for selected driver
    async function openDriverMap(driverId) {
      const snap = await get(ref(db, "drivers/" + driverId));
      if (!snap.exists()) { alert("Driver not found"); return; }
      const driver = snap.val();

      if (!driver.lat || !driver.lng) {
        alert("Driver has no location (lat/lng) data.");
        return;
      }

      const popup = document.getElementById("mapPopup");
      popup.style.display = "flex";
      const mapEl = document.getElementById("mapCanvas");
      mapEl.innerHTML = "";

      const map = new google.maps.Map(mapEl, {
        center: { lat: Number(driver.lat), lng: Number(driver.lng) },
        zoom: 13,
      });

      const markers = [];
      const renderers = [];

      // Driver marker
      const driverMarker = new google.maps.Marker({
        position: { lat: Number(driver.lat), lng: Number(driver.lng) },
        map,
        title: driver.name || "Driver",
        icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });
      markers.push(driverMarker);

      const riderPoints = [];
      if (driver.rider1_lat && driver.rider1_lng) {
        riderPoints.push({ lat: Number(driver.rider1_lat), lng: Number(driver.rider1_lng), label: "Rider 1" });
      }
      if (driver.rider2_lat && driver.rider2_lng) {
        riderPoints.push({ lat: Number(driver.rider2_lat), lng: Number(driver.rider2_lng), label: "Rider 2" });
      }

      riderPoints.forEach((rp) => {
        const m = new google.maps.Marker({
          position: { lat: rp.lat, lng: rp.lng },
          map,
          title: rp.label,
          icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        });
        markers.push(m);
      });

      const directionsService = new google.maps.DirectionsService();
      for (let i = 0; i < riderPoints.length; ++i) {
        const rp = riderPoints[i];
        try {
          const result = await directionsService.route({
            origin: { lat: Number(driver.lat), lng: Number(driver.lng) },
            destination: { lat: rp.lat, lng: rp.lng },
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC
          });
          const renderer = new google.maps.DirectionsRenderer({
            map,
            directions: result,
            suppressMarkers: true,
            preserveViewport: true,
            polylineOptions: {
              strokeColor: i === 0 ? "#0078ff" : "#ff4081",
              strokeOpacity: 0.95,
              strokeWeight: 6,
              icons: [{
                icon: { path: google.maps.SymbolPath.FORWARD_OPEN_ARROW },
                offset: '25px',
                repeat: '50px'
              }]
            }
          });
          renderers.push(renderer);
        } catch (err) {
          console.error("Directions error:", err);
        }
      }

      const bounds = new google.maps.LatLngBounds();
      bounds.extend({ lat: Number(driver.lat), lng: Number(driver.lng) });
      riderPoints.forEach(rp => bounds.extend({ lat: rp.lat, lng: rp.lng }));
      if (riderPoints.length === 0) map.setZoom(15); else map.fitBounds(bounds);

      popup._mapObjects = { markers, renderers, map };
    }

    // üî∏ Close map popup
    window.closeMapPopup = function () {
      const popup = document.getElementById("mapPopup");
      if (!popup) return;
      const data = popup._mapObjects;
      if (data) {
        if (data.markers) data.markers.forEach(m => m.setMap(null));
        if (data.renderers) data.renderers.forEach(r => r.setMap && r.setMap(null));
        popup._mapObjects = null;
      }
      popup.style.display = "none";
    };
  </script>

  <!-- Google Maps -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBb3cYzaeiSbLn2wO7vwvLBHLaErz6pBeo&callback=initMap"></script>
  <script>function initMap() {}</script>

  <!-- üíÖ Modern Mobile-Friendly Styles -->
  <style>
    :root {
      --accent: #0078ff;
      --muted: #7b8aa3;
      --bg: #f4f7fb;
      --card-bg: #fff;
      --success: #2ea44f;
      --danger: #d73a49;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 15px;
      color: #1e293b;
    }

    h1 {
      color: #173a6c;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    #searchInput {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d0d6df;
      width: 100%;
      max-width: 320px;
      font-size: 15px;
      outline: none;
      transition: 0.2s;
    }

    #searchInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 4px var(--accent);
    }

    .tableWrap {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 650px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eef2f7;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: var(--accent);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tr.onlineRow:hover { background: #ecfdf5; }
    tr.offlineRow:hover { background: #fef2f2; }

    .viewMapBtn, .deleteBtn {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      transition: 0.2s;
      margin: 3px 0;
    }

    .viewMapBtn { background: var(--success); }
    .deleteBtn { background: var(--danger); }

    .viewMapBtn:hover { background: #22b55b; }
    .deleteBtn:hover { background: #f05252; }

    #mapPopup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    #mapBox {
      width: 90%;
      height: 80%;
      background: var(--card-bg);
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      animation: fadeIn 0.3s ease;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
    }

    #closeMap {
      position: absolute;
      right: 14px;
      top: 14px;
      background: #ff5252;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      color: var(--muted);
    }

    #driverCount {
      font-weight: 600;
      color: var(--accent);
    }

    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: #005ed1; }

    /* üåç Responsive */
    @media (max-width: 768px) {
      h1 { font-size: 1.25rem; }
      .tableWrap { padding: 6px; }
      th, td { padding: 8px; font-size: 13px; }
      #mapBox { width: 95%; height: 70%; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>

<body>
  <h1>Admin ‚Äî Drivers (with Directions)</h1>

  <div class="toolbar">
    <div class="meta">
      <input id="searchInput" placeholder="Search name, gmail or mobile" oninput="renderTable()" />
      <div>Total: <span id="driverCount">0</span></div>
    </div>
    <div>
      <button onclick="renderTable()">Refresh</button>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Gmail</th><th>Mobile</th><th>Status</th><th>Bookings</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="driverTableBody">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Map popup -->
  <div id="mapPopup" onclick="if(event.target===this) closeMapPopup()">
    <div id="mapBox">
      <button id="closeMap" onclick="closeMapPopup()">‚úñ</button>
      <div id="mapCanvas"></div>
    </div>
  </div>
</body>
</html>
