<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel ‚Äî Drivers with Directions (Leaflet + OSRM)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""/>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCsZcn4VPhpnlgU0K_NPHPINjq9Qi5iVT8",
  authDomain: "mydatabase-e7c01.firebaseapp.com",
  databaseURL: "https://mydatabase-e7c01-default-rtdb.firebaseio.com",
  projectId: "mydatabase-e7c01",
  storageBucket: "mydatabase-e7c01.firebasestorage.app",
  messagingSenderId: "447471871540",
  appId: "1:447471871540:web:d48721caa65174b1598c61",
  measurementId: "G-80M4PND75H"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global variable for all drivers
    let allDrivers = {};

    // üî∏ Listen for driver data
    onValue(ref(db, "drivers"), snapshot => {
      allDrivers = snapshot.exists() ? snapshot.val() : {};
      renderTable();
    });

    // üî∏ Render driver table
    window.renderTable = function () {
      const tbody = document.getElementById("driverTableBody");
      tbody.innerHTML = "";
      let count = 0;
      const q = document.getElementById("searchInput").value.trim().toLowerCase();

      for (const id in allDrivers) {
        const d = allDrivers[id];
        if (!d) continue;

        // search filter
        if (q && !((d.name||"").toLowerCase().includes(q) || (d.gmail||"").toLowerCase().includes(q) || (d.mobile||"").includes(q)))
          continue;

        count++;
        const tr = document.createElement("tr");
        tr.className = d.online ? "onlineRow" : "offlineRow";

        const rider1 = d.rider1_id || "-";
        const rider2 = d.rider2_id || "-";
        const code1 = d.booking1_code || "-";
        const code2 = d.booking2_code || "-";

        tr.innerHTML = `
          <td>${d.name || "-"}</td>
          <td>${d.gmail || "-"}</td>
          <td>${d.mobile || "-"}</td>
          <td>${d.online ? "üü¢ Online" : "üî¥ Offline"}</td>
          <td>
            <div>üë§ Rider1: ${rider1}</div>
            <div>Code: ${code1}</div>
            <hr>
            <div>üë§ Rider2: ${rider2}</div>
            <div>Code: ${code2}</div>
          </td>
          <td>
            <button class="viewMapBtn" data-id="${id}">üó∫Ô∏è View Map</button>
            <button class="deleteBtn" data-id="${id}">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      document.getElementById("driverCount").innerText = count;

      // üî∏ Attach Delete Button Functionality
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = async (e) => {
          const id = e.target.dataset.id;

          const code = prompt("üîê Enter admin code to delete this driver:");
          if (code !== "Chintu@Admin2025") {
            alert("‚ùå Invalid code. You are not authorized to delete this driver.");
            return;
          }

          if (!confirm("‚ö†Ô∏è Are you sure you want to delete this driver?")) return;

          try {
            await remove(ref(db, "drivers/" + id));
            alert("‚úÖ Driver deleted successfully!");
          } catch (error) {
            console.error(error);
            alert("‚ö†Ô∏è Failed to delete driver. Check console for details.");
          }
        };
      });

      // üî∏ Attach View Map Button Functionality
      document.querySelectorAll(".viewMapBtn").forEach(btn => {
        btn.onclick = async (e) => {
          const id = btn.dataset.id;
          await openDriverMap(id);
        };
      });
    };

    // --------------------------------------------------------------------------------
    // Leaflet + OSRM openDriverMap implementation (replaces Google Maps logic)
    // --------------------------------------------------------------------------------

    // make sure global Leaflet 'L' exists (we included leaflet.js separately)
    if (typeof window.L === "undefined") {
      console.error("Leaflet (L) not found. Make sure you included Leaflet script before this module.");
    }

    async function openDriverMap(driverId) {
      const popup = document.getElementById("mapPopup");
      popup.style.display = "flex";
      const mapEl = document.getElementById("mapCanvas");
      mapEl.innerHTML = "";

      const snap = await get(ref(db, "drivers/" + driverId));
      if (!snap.exists()) { alert("Driver not found"); return; }
      let driver = snap.val();

      if (!driver.lat || !driver.lng) {
        alert("Driver has no location data.");
        return;
      }

      // --- Initialize Leaflet map ---
      const map = L.map(mapEl, { zoomControl: true });

      // Street layer (OpenStreetMap)
      const streetLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Satellite layer (Esri WorldImagery)
      const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri'
      });

      const baseMaps = {
        "Street": streetLayer,
        "Satellite": satelliteLayer
      };
      L.control.layers(baseMaps, {}, { position: "topright" }).addTo(map);

      // Driver marker (green)
      const driverIcon = L.icon({
        iconUrl: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        iconSize: [32, 32],
        iconAnchor: [16,32]
      });
      const riderIcon = L.icon({
        iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        iconSize: [28, 28],
        iconAnchor: [14, 28]
      });

      const driverMarker = L.marker([Number(driver.lat), Number(driver.lng)], { icon: driverIcon }).addTo(map).bindTooltip(driver.name || "Driver");
      // rider markers array
      const riderPoints = [];
      if (driver.rider1_lat && driver.rider1_lng) riderPoints.push({ lat: +driver.rider1_lat, lng: +driver.rider1_lng, label: "Rider 1" });
      if (driver.rider2_lat && driver.rider2_lng) riderPoints.push({ lat: +driver.rider2_lat, lng: +driver.rider2_lng, label: "Rider 2" });

      const riderMarkers = riderPoints.map(rp => L.marker([rp.lat, rp.lng], { icon: riderIcon }).addTo(map).bindTooltip(rp.label));

      // Containers for polylines (one per rider)
      let activePolylines = [];

      // Helper: OSRM route call (returns array of {lat,lng})
      async function getOsrmRoute(start, end) {
        try {
          // OSRM expects: lng,lat
          const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
          const r = await fetch(url);
          if (!r.ok) throw new Error("OSRM error " + r.status);
          const js = await r.json();
          if (!js.routes || !js.routes[0]) throw new Error("No route");
          const coords = js.routes[0].geometry.coordinates.map(c => ({ lat: c[1], lng: c[0] }));
          return coords;
        } catch (err) {
          console.error("OSRM fetch failed:", err);
          return null;
        }
      }

      // Draw routes from a start position to each rider and animate polylines
      async function drawRoutes(fromPos) {
        // clear old
        activePolylines.forEach(p => p.remove());
        activePolylines = [];

        for (let i = 0; i < riderPoints.length; i++) {
          const rp = riderPoints[i];
          const coords = await getOsrmRoute({ lat: fromPos.lat, lng: fromPos.lng }, { lat: rp.lat, lng: rp.lng });
          if (!coords) continue;

          // create polyline initially empty, then progressively add points (visual animation)
          const poly = L.polyline([], { weight: 5, opacity: 0.9, color: i === 0 ? "#0078ff" : "#ff4081" }).addTo(map);
          activePolylines.push(poly);

          // animate adding points (fast): push a few points per tick to speed up long routes
          let idx = 0;
          const stepAdd = () => {
            const chunk = 6;
            const end = Math.min(idx + chunk, coords.length);
            for (let k = idx; k < end; k++) poly.addLatLng([coords[k].lat, coords[k].lng]);
            idx = end;
            if (idx < coords.length) requestAnimationFrame(stepAdd);
          };
          stepAdd();
        }
      }

      // Fit bounds to driver + riders
      const bounds = L.latLngBounds([]);
      bounds.extend([Number(driver.lat), Number(driver.lng)]);
      riderPoints.forEach(rp => bounds.extend([rp.lat, rp.lng]));
      map.fitBounds(bounds.pad(0.2));

      let lastPos = { lat: +driver.lat, lng: +driver.lng };

      // --- Animate marker along route points with easing ---
      function animateMarkerAlongPath(marker, pathPoints, totalDuration = 1200) {
        if (!pathPoints || pathPoints.length === 0) return Promise.resolve();

        // Build cumulative distances
        const distances = [0];
        for (let i = 1; i < pathPoints.length; i++) {
          const a = pathPoints[i - 1], b = pathPoints[i];
          const d = haversineDistance(a, b);
          distances.push(distances[i - 1] + d);
        }
        const totalDist = distances[distances.length - 1];
        if (totalDist === 0) return Promise.resolve();

        const startTime = performance.now();
        return new Promise(resolve => {
          function frame(now) {
            const t = Math.min((now - startTime) / totalDuration, 1);
            // ease-in-out
            const eased = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            const targetDist = eased * totalDist;

            // find segment
            let seg = 0;
            while (seg < distances.length - 1 && distances[seg + 1] < targetDist) seg++;
            const segStart = distances[seg];
            const segEnd = distances[seg + 1] || segStart;
            const segRatio = segEnd === segStart ? 0 : (targetDist - segStart) / (segEnd - segStart);

            const p1 = pathPoints[seg];
            const p2 = pathPoints[Math.min(seg + 1, pathPoints.length - 1)];
            const lat = p1.lat + (p2.lat - p1.lat) * segRatio;
            const lng = p1.lng + (p2.lng - p1.lng) * segRatio;
            marker.setLatLng([lat, lng]);

            if (t < 1) requestAnimationFrame(frame);
            else resolve();
          }
          requestAnimationFrame(frame);
        });
      }

      // Haversine (km)
      function haversineDistance(p1, p2) {
        const R = 6371; // km
        const dLat = ((p2.lat - p1.lat) * Math.PI) / 180;
        const dLng = ((p2.lng - p1.lng) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((p1.lat * Math.PI) / 180) *
          Math.cos((p2.lat * Math.PI) / 180) *
          Math.sin(dLng / 2) ** 2;
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      // initial draw
      await drawRoutes({ lat: +driver.lat, lng: +driver.lng });

      // update listener for driver
      const driverRef = ref(db, "drivers/" + driverId);
      onValue(driverRef, async (snap) => {
        if (!snap.exists()) return;
        const updated = snap.val();
        if (!updated.lat || !updated.lng) return;

        const newPos = { lat: +updated.lat, lng: +updated.lng };

        // animate along OSRM path from current marker position to newPos
        try {
          const cur = driverMarker.getLatLng();
          const joinPath = await getOsrmRoute({ lat: cur.lat, lng: cur.lng }, { lat: newPos.lat, lng: newPos.lng });
          if (joinPath && joinPath.length > 0) {
            await animateMarkerAlongPath(driverMarker, joinPath, 1000);
          } else {
            // fallback simple linear interpolation
            await animateMarkerAlongPath(driverMarker, [ { lat: cur.lat, lng: cur.lng }, newPos ], 800);
          }
        } catch (err) {
          console.error("Animate fallback", err);
          driverMarker.setLatLng([newPos.lat, newPos.lng]);
        }

        const distance = haversineDistance(lastPos, newPos);
        if (distance > 0.1) { // >100m -> redraw routes
          lastPos = newPos;
          await drawRoutes(newPos);
        }
      });

      // --- Expose cleanup references for popup close ---
      popup._leafletMap = map;
      popup._leafletCleanup = () => {
        try {
          activePolylines.forEach(p => p.remove());
          riderMarkers.forEach(m => m.remove());
          driverMarker.remove();
          map.remove();
        } catch (e) { /* ignore */ }
      };
    }

    // Expose globally so renderTable can call
    window.openDriverMap = openDriverMap;

    // üî∏ Close map popup
    window.closeMapPopup = function () {
      const popup = document.getElementById("mapPopup");
      if (!popup) return;
      if (popup._leafletCleanup) popup._leafletCleanup();
      popup._leafletCleanup = null;
      popup._leafletMap = null;
      popup.style.display = "none";
    };
    // üî∏ Fullscreen Toggle
document.addEventListener("click", function (e) {
  if (e.target.id === "toggleFullscreen") {
    const mapBox = document.getElementById("mapBox");

    if (!document.fullscreenElement) {
      mapBox.requestFullscreen().catch(err => {
        console.error("Fullscreen error:", err);
      });
    } else {
      document.exitFullscreen();
    }
  }
});

  </script>

  <!-- Leaflet JS (non-module; must be included before Leaflet use) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- QRCode library (used by your UI) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- üíÖ Modern Mobile-Friendly Styles -->
  <style>
    :root {
      --accent: #0078ff;
      --muted: #7b8aa3;
      --bg: #f4f7fb;
      --card-bg: #fff;
      --success: #2ea44f;
      --danger: #d73a49;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 15px;
      color: #1e293b;
    }

    h1 {
      color: #173a6c;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    #searchInput {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d0d6df;
      width: 100%;
      max-width: 320px;
      font-size: 15px;
      outline: none;
      transition: 0.2s;
    }

    #searchInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 4px var(--accent);
    }

    .tableWrap {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 650px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eef2f7;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: var(--accent);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tr.onlineRow:hover { background: #ecfdf5; }
    tr.offlineRow:hover { background: #fef2f2; }

    .viewMapBtn, .deleteBtn {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
      transition: 0.2s;
      margin: 3px 0;
    }

    .viewMapBtn { background: var(--success); }
    .deleteBtn { background: var(--danger); }

    .viewMapBtn:hover { background: #22b55b; }
    .deleteBtn:hover { background: #f05252; }

    #mapPopup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    #mapBox {
      width: 90%;
      height: 80%;
      background: var(--card-bg);
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
      animation: fadeIn 0.3s ease;
    }

    #mapCanvas {
      width: 100%;
      height: 100%;
      /* Leaflet needs height; mapBox already defines height */
    }

    #closeMap {
      position: absolute;
      right: 14px;
      top: 14px;
      background: #ff5252;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 99999;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      color: var(--muted);
    }

    #driverCount {
      font-weight: 600;
      color: var(--accent);
    }

    button {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: #005ed1; }

    .fullmap{
       position:absolute;
    left:96%;
    top:65px;
    z-index:99999;
    background:#f1eeee;
    color:rgb(0, 0, 0);
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    font-size:39px;
    }

    /* üåç Responsive */
    @media (max-width: 768px) {
      h1 { font-size: 1.25rem; }
      .tableWrap { padding: 6px; }
      th, td { padding: 8px; font-size: 13px; }
      #mapBox { width: 95%; height: 70%; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

.qrcode {
  position: fixed;
  padding: 15px;
  width: 20%;
  background: rgb(255, 255, 255);
  border-radius: 15px;
  box-shadow: 0 4px 15px rgb(0 0 0 / 20%);
  transform: scale(0);        /* Hidden initially */
  transform-origin: center;   /* Scale from center */
  transition: transform 0.5s ease;
  left: 40%;
  right: 40%;
}
.qrcodebutton {
  width: 100%;
  height: 35px;
  background-color: rgb(102, 117, 253);
  border-radius: 16px;
  cursor: pointer;
  margin: 10px 0 0 0 ;
}

.qrcodebutton:hover {
  background-color: rgb(36, 50, 245);
}
.qrcodeclose {
  width: 100%;
  height: 35px;
  background-color: rgb(241, 130, 56);
  border-radius: 16px;
  cursor: pointer;
  margin: 10px 0 0 0 ;
}

.qrcodeclose:hover {
  background-color: rgb(230, 46, 21);
}
@media (max-width: 600px) {
  .qrcode {
    padding: 12px;
    width: 90%;
    left: 5%;
  }

  .qrcodebutton {
    height: 38px;
    font-size: 15px;
  }
  .fullmap{
    left:84%;
  }
}

.logo {
  position: absolute;
  width: 90px;
  height: 90px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.logo img {
  width: 70px;
}
  </style>
</head>

<body>
  <h1>Admin ‚Äî Drivers (with Directions)</h1>

  <div class="qrcode" id="hiip">
    <div id="p"></div>
     <div class="logo">
        <img src="https://tse1.mm.bing.net/th/id/OIP.r5wSc0-B3GQMSzAjIByfgQHaHZ?rs=1&pid=ImgDetMain&o=7&rm=3" alt="logo">
      </div>
    <button class="qrcodeclose" id="payclose">Close QR Code</button>
  </div>
    <div class="qrcode" id="hii">
<div id="q"></div>
<button class="qrcodebutton" onclick="chintu()">Download QR Code</button>
<button class="qrcodeclose" id="cliclose">Close QR Code</button>
</div>

<button id="clickhere">open QR code</button>

  <div class="toolbar">
    <div class="meta">
      <input id="searchInput" placeholder="Search name, gmail or mobile" oninput="renderTable()" />
      <div>Total: <span id="driverCount">0</span></div>
    </div>
    <div>
      <button onclick="renderTable()">Refresh</button>
      <button id="payhere" > payment</button>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Gmail</th><th>Mobile</th><th>Status</th><th>Bookings</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="driverTableBody">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Map popup -->
  <div id="mapPopup" onclick="if(event.target===this) closeMapPopup()">
    <div id="mapBox">
      <button class="fullmap" id="toggleFullscreen"
  >
  ‚õ∂
</button>

      <div id="mapCanvas"></div>
    </div>
  </div>

  <!-- Small inline script for QR code UI (non-module) -->
  <script>
    document.getElementById("clickhere").addEventListener("click",function(){
      const result=document.getElementById("q");
      document.getElementById("q").innerHTML="";
      new QRCode(result,{
        text:"https://peoples-hfmh.onrender.com/",
        width:300,
        height:300
      });
      window.chintu=function(){
        const img=document.querySelector("#q img");
        const link=document.createElement("a");
        link.href=img.src;
        link.download="qr_code.png";
        link.click();
      }
      setTimeout(()=>{
        document.getElementById("hii").style.transform="scale(1)";
      },200);
    });

    document.getElementById("cliclose").addEventListener("click",function(){
      document.getElementById("hii").style.transform="scale(0)";
    });

    document.getElementById("payhere").addEventListener("click",function(){
      const result=document.getElementById("p");
      document.getElementById("p").innerHTML="";
      new QRCode(result,{
        text:"upi://pay?pa=chintukr32101-1@oksbi&pn=Chintu&cu=INR",
        width:300,
        height:300
      });
      setTimeout(()=>{
        document.getElementById("hiip").style.transform="scale(1)";
      },200);
    });
    document.getElementById("payclose").addEventListener("click",function(){
      document.getElementById("hiip").style.transform="scale(0)";
    });
  </script>
</body>
</html>
